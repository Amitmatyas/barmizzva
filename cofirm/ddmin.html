<!DOCTYPE html>
<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>בר מצווה לעמית</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script>
      emailjs.init("xMUcc8A1COpyd1SSY"); // שמור על ה-ID שלך
    </script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 2rem;
        background-color: #f9f9f9;
        direction: rtl;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 2rem;
      }

      th,
      td {
        padding: 0.75rem;
        border: 1px solid #ddd;
      }

      th {
        background-color: #f2f2f2;
      }

      button {
        padding: 0.5rem 1rem;
        margin: 0.2rem;
        cursor: pointer;
        background-color: #e0e0e0;
        border: none;
        border-radius: 5px;
      }

      .status-מגיע-ה {
        color: green;
        font-weight: bold;
      }

      .status-לא-מגיע-ה {
        color: red;
        font-weight: bold;
      }

      .status-לא-ענה {
        color: gray;
      }
    </style>
  </head>
  <body>
    <h1>בר מצווה לעמית</h1>
    <table id="guestsTable">
      <thead>
        <tr>
          <th>שם</th>
          <th>סטטוס</th>
          <th>אימייל</th>
          <th>פעולה</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAHtzbKXHugX3v2FSZL9MR-DWvncoAeM78",
        authDomain: "bar-mitzva-amit.firebaseapp.com",
        projectId: "bar-mitzva-amit",
        storageBucket: "bar-mitzva-amit.appspot.com",
        messagingSenderId: "786757592859",
        appId: "1:786757592859:web:fa55b4604a2e0d78fcebbf",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      function getStatusClass(status) {
        if (status === "מגיע/ה") return "status-מגיע-ה";
        if (status === "לא מגיע/ה") return "status-לא-מגיע-ה";
        return "status-לא-ענה";
      }

      function createRow(attendee) {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = attendee.full_name;
        tr.appendChild(nameTd);

        const statusTd = document.createElement("td");
        const statusText = document.createElement("span");
        statusText.textContent = attendee.attendance || "לא ענה";
        statusText.className = getStatusClass(attendee.attendance);
        statusTd.appendChild(statusText);
        tr.appendChild(statusTd);

        const emailTd = document.createElement("td");
        emailTd.textContent = attendee.email || "";
        tr.appendChild(emailTd);

        const actionsTd = document.createElement("td");

        ["מגיע/ה", "לא מגיע/ה"].forEach((status) => {
          const btn = document.createElement("button");
          btn.textContent = status;
          btn.onclick = () => {
            db.collection("invitees")
              .doc(attendee.id)
              .update({ attendance: status })
              .then(() => {
                statusText.textContent = status;
                statusText.className = getStatusClass(status);

                // רק אם נבחר "מגיע/ה" שולחים מייל
                if (status === "מגיע/ה") {
                  emailjs
                    .send("service_laxsrg8", "barmizzva", {
                      guest_name: attendee.full_name,
                      status: status,
                      email: attendee.email,
                    })
                    .then(() => {
                      console.log("Email sent to", attendee.email);
                    })
                    .catch((error) => {
                      console.error("Email error", error);
                    });
                }
              });
          };
          actionsTd.appendChild(btn);
        });

        tr.appendChild(actionsTd);
        return tr;
      }

      db.collection("invitees")
        .get()
        .then((querySnapshot) => {
          const tbody = document.querySelector("#guestsTable tbody");
          querySnapshot.forEach((doc) => {
            const attendee = { id: doc.id, ...doc.data() };
            const row = createRow(attendee);
            tbody.appendChild(row);
          });
        });
    </script>
  </body>
</html>
